
-----------------
--- CombiMets ---
-----------------

- tree data is adjacency list 
- using python pkg to draw tree
- clustered the trees (for some unknown reason)
    - 'reveals' topology
- dpclust 
    - https://github.com/Wedge-lab/dpclust
    - unsure how to identify reseeding 

----------------
--- AJCC 7th ---
----------------
https://www.facs.org/media/j30havyf/ajcc_7thed_cancer_staging_manual.pdf

general notes 
- pancreas, 'other biliary' have N01 staging. why some cases of N2?
- appendix:
    - Carcinoma & Carcinoid are distinct categories 
    - Carcinoma == N012  
    - Carcinoid == N01  
- Corpus Uteri:
    - Carcinomas * Sarcomas are distinct categories 
        - Carcinosarcomas should be staged as carcinoma. 
    - Carcinomas == N012 
    - Sarcomas   == N01  

- CS tumor size % CS extension eval == method for evaluating T-stage 
- CS lymph nodes eval               == method for evaluating N-stage 
- T-stage 
    - size or contiguous extension of the primary tumor. 
    - roles of the size component and the extent of contiguous spread in defining T are specifically defined for each cancer site
- N-stage 
    - Absence, or presence and extent of cancer in the regional draining lymph nodes. 
    - Nodal involvement is categorized by the number of positive nodes, and 
    - for certain cancer sites by the involvement of specific regional nodal groups. 

- for some cancers in AJCC7th and above, M1b designates distant metastases.
- Stage is a combination of TNM. 
                      T    N    M
  eg Lung Stage IIA:  T2b  N0  M0
                      T1a  N1  M0
                      T1b  N1  M0
                      T2a  N1  M0 
  
  eg Lung Stage IIIA: T1a  N2  M0
                      T1b  N2  M0
                      T2a  N2  M0
                      T2b  N2  M0
                      T3   N1  M0
                      T3   N2  M0
                      T4   N0  M0       <- T4 + N0/N1 (N2/N3 pushes you into stage IIIB) 
                      T4   N1  M0       <- 
  
  eg Lung Stage IV    Any  Any M1a
                      Any  Any M1b

Thyroid (page 103)
- N-stage 
    N0      No regional lymph node metastasis
    N1      Regional lymph node metastasis

lung (page 269)
- changes: 
    6th                     7th 
    -----------------------------
    T2 (>7 cm in size)       T3 
    T4 (same lobe nodules)   T3

- Clinical T-stage
    T0      No evidence of primary tumor
    T1      Tumor < 3 cm.
            surrounded by lung or visceral pleura.
            not in the main bronchus.
    T2      3cm <= Tumor <= 7cm, or any of the following:
            - Involves main bronchus
            - Invades visceral pleura
            - Associated with local atelectasis or obstructive pneumonitis
    T3      Tumor > 7 cm, or tumor directly invades:
            - parietal pleural 
            - diaphragm 
            - etc 
    T4      Tumor of any size that invades any of the following:
            - mediastinum
            - heart 
            - etc 

- Clinical N-stage 
    N0      No regional lymph node metastases
    N1      Metastasis in ipsilateral peribronchial and/or ipsilateral hilar lymph nodes
            and intrapulmonary nodes, including involvement by direct extension.
    N2      Metastasis in ipsilateral mediastinal and/or subcarinal lymph node(s)
    N3      Metastasis in 
            - contralateral mediastinal, 
            - contralateral hilar, 
            - ipsilateral or contralateral scalene, or 
            - supraclavicular lymph node(s)

prostate (page 473)
- changes:
    - Extraprostatic invasion with microscopic bladder neck invasion (T4) is included with T3a
    - Gleason Score now recognized as the preferred grading system

- Clinical T-stage
    T0      No evidence of primary tumor
    T1      Clinically inapparent tumor neither palpable nor visible by imaging.
    T2      Tumor confined within prostate
    T3      Tumor extends through the prostate capsule
    T4      Tumor is fixed or invades adjacent structures other than seminal vesicles. eg 
            - external sphincter
            - rectum
            - bladder
            - etc 

- Pathologic T-stage
    T2      Organ confined 
    T3      Extraprostatic extension
    T4      Invasion of rectum, levator muscles, and /or pelvic wall 

- Clinical N-stage 
    N0      No regional lymph node metastasis
    N1      Metastasis in regional lymph node(s)

------------
--- TODO ---
------------
https://www.aacr.org/blog/2022/01/21/new-dimensions-in-cancer-biology-updated-hallmarks-of-cancer-published/
^ 2022 hallmarks of cancer 

https://www.nature.com/articles/s41586-022-04738-6
^ copy number signatures. Seems good to do for BM right now. Big ez win. 

https://cancer.sanger.ac.uk/cmc/help
^ cancer mutation census data has richer data than previously thought. 
  eg tiers are well explained, sources of data etc, and has hallmarks for each gene.

NA values 
- only 522588 records with 

heatmap but instead of cancer_group its broken down by Tstage / Grade etc


Angles:
- Clinical vs biological common/uncommon 
    - prevalence vs cases 
    - p(BM | met)
- Features (TNG-stage) which contribute to BM risk
    - locoregional vs distant lymph nodes 
    - cancer_group? profiles? Cancer types which are similar in profile 



- Loco; Dist; Loco-Dist;
    Brain   ------|-x-----
    Bone    ------|-----x-
    Lung    ----x-|-------
    Liver   ----x-|-------

Normalise TNG-stage 


Paper 
- Lung smoker/non-smoker risk profiles similar or different? 

- Prevalence & new definition of common 
    - barplot case load, brain / lung etc prevalence
    - common vs uncommon (prevalence, preference)

- TNM & Brain met risk 
    - T-stage more important than N/G 

- cancer type more important than histological type 
- some cancers histology doesn't mean anything, some cancer show different patterns based on hist type 
- breast: epilthelial neoplasms == LUNG types 
- Breast 
    - Is it T-stage or subtype which is more important for BM risk? 
    - clustermap: breast try T-stage as group, subtype as feature
- Prostate & Thyroid are similar 
- PSA linear increasing trend in BM risk 
- All GI are similar 
- N0 -> N1N2 -> N3 
- dramatic vs rapid increases in risk 
    - lineplots
- TNBC odd dip at N2






- forest plots about risk 









- heatmaps 
    - add underlying numbers 
- all cancer types (overall)
- multivariate predictor with feature selection
- overlaid line plots instead of heatmap 
    - classic connected scatterplot style
    - 
    - Breast      -----T1----T2----T3----
    - Colorectal  -----T1----T2-T3-------


Lung met to Lung???

https://staging.seer.cancer.gov/tnm/schema/1.0/liver/?breadcrumbs=(~schema_list~)

information about metastatic sites: (search 'Metastatic Sites')
https://www.facs.org/media/j30havyf/ajcc_7thed_cancer_staging_manual.pdf

Liver only NX, N0, N1
(Page 133)
https://www.facs.org/media/tauiudl3/ajcc_6thed_cancer_staging_manual_part1.pdf

SEER 
- month of diagnosis / month of diagnosis recode can't be used for case listings (only survival?)
- sessions 
    - frequency 
    - rate 
    - survival 
    - limited-duration prevalence

Features 
- do following site groups per feature below:
    - all (general trend)
    - lung vs rest
    - common vs uncommon 
    - each cancer_type/cancer_group
- t_stage_ajcc
- n_stage_ajcc
- g_stage_ajcc (careful, breast etc have different staging)
- Grade 
- regional_nodes
- distant_ln mets 
- age 
- gender 
- diagnosis_year
- diagnosis_agebin 
- num_malignant_tumors
- num_benign_tumors
- hist_type / hist_type_descr / hist_cateogry


Prevalence Metrics 
- Prevalence
- Odds ratio 

Incidence Metrics 
- Incidence rate ratio
- Cox proportional hazards

Filtering
- interested in denovo met 
- primary brain isn't relevant for cancer_type feature calculations
    - Remove patients with brain as cancer_type
    - 73973 records
    - 71510 patients
- Keep 'Unknown' as a category for site (tissue types)
- remove any records which are 'BENIGN'
- patients with multiple records of same cancer_type
    - choose first record
    - unless hist_type is different 

                            brain_met?
2015    Kidney  MALIGNANT       False    <- prevalence: use this record
2017    Breast  MALIGNANT       True     <- prevalence: use this record
2018    Breast  MALIGNANT       False    <- prevalence: ignore
2020    Breast  MALIGNANT       True     <- prevalence: ignore




define common uncommon 
- lowgrade initial incidence 
- highgrade initial prevalence 

kaplan meyer 
- 2010-2014 vs 2015-2019
- 


Breast      T1->T4 risk ratio brain met 1:130 
Colorectal  T1->T4 risk ratio brain met 1:2



Brain preference 
- BRAIN_PREFERENCE_MEASURE: ratio of bm vs highest nonbm category
- code for incidence: 
    - use for breast subtypes
    - incidence rate ratios
- survival curves: 
    - explore why weird 
    - do for lung/liver/bone as sanity check? 
- Normalisation:
    - slow vs fast (aggressiveness)
    - early detection vs late
- placenta


Factors 
- cancer_type 
- cancer_group 
- diagnosis year
- age at diagnosis
- num benign tumors
- num malignant tumors
- gender
- histologic_type 
- histologic_code  
- histologic_code  

-----------------------------
--- METASTASIS PREFERENCE ---
-----------------------------
https://www.nature.com/articles/s41568-022-00497-8

oncofetal signatures in brain metastasis 


------------------
--- LITERATURE ---
------------------

Common
Lung, breast, skin, esophagus, kidney

Uncommon 
Leukemia, prostate, colorectal 

Breast
- Higher metastasis rate: Triple negative breast cancer (TNBC) and HER2 positive (HER2+)
- Lower metastasis rate: Hormone receptor positive tumors (ER+ or PR+) 

Lung
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9689009/
- Only cases with pathologically confirmed diagnoses were included
- Fields: 
    - age at diagnosis
    - sex 
    - ICD-0-3 TNG stage, grade 
    - histology codes
    - histological diagnosis
    - history of other malignancy
    - presence of metastasis
    - sites of distant metastasis
    - presence of recurrence
    - sites of recurrence
- Younger patients have higher metastasis rate in most histologic subtypes
- Bone (60%), CNS (45%), liver (25%) and adrenal gland (20%) are preferred secondary sites
- histologic types are important
    - Nonmucinous adenocarcinoma:                   ↑ Bone 
    - Small cell carcinoma:                         ↑ Liver 
    - large cell neuroendocrine carcinoma (LCNEC):  ↑ Liver; ↓ Bone 
    - squamous cell carcinoma:                      ↓ CNS 


8140 Adenocarcinoma


-----------------
--- QUESTIONS ---
-----------------
Lung, breast, skin, renal, colorectal
- breast -> brain: low 
- lung -> brain: high

Propensity
- eg prevalence within metastatic prostate cancer
- prostate -> brain 
- prostate -> other secondary sites

prevalence - 1 timepoint 
incidence  - 2 timepoint 

biological vs clinical definitions
looking forward vs retroactively



Factors which contribute to brain met risk 
- primary 
- histological type 
- subtypes (well established clinical subtype / division of sig. proportion) (breast Hr/HER2)
- age 
- pediatric cancer? 


Common vs uncommon
1. Do the existing common | uncommon categories make sense? (prevalence) [✔] 
    - What about splitting breast by subtype (HR/HER2 etc)

2. Is there a better, data-driven definition of common vs uncommon? [-]
    - TODO set min_cases=1000
    - TODO incidence, not prevalence

3. Do common | uncommons have differences in clinical features?
    - TNM stage, group stage, grade, histology, rate of spread, blood markers, cancer subtypes (HER2+/- etc)

Histology 
- histology code may be more informative than primary 
    - lung has high propensity for metastasis, but different hist_types show different patterns of metastasis
    - 

Secondary site
4. For each primary, what is it's liver/bone/lung/brain secondary site tendancies (prevalence, incidence)
5. What clinical feature(s) differentiate metastasis to brain, vs metastasis to other regions?
    - include age, ethnicity, gender



# not as important
Lymph nodes
6. What is the relationship between local vs distant nodes positive & brain met incidence?
    - What is the incidence rate of brain met, if spread only to local lymph nodes?
    - What is the incidence rate of brain met, if spread to distant lymph nodes?
    - Incidence rate ratio of the above
    - Survival curve (time to brain met) of the above

7. clustering primaries vs brain met risk
    - all features + smoking, breast subtype etc










- Risk 
    - single variable 
    - multiple variables 
        - TSTAGE=1; NSTAGE=1vs2
        - TSTAGE=2; NSTAGE=1vs2
        - TSTAGE=3; NSTAGE=1vs2
        - TSTAGE=4; NSTAGE=1vs2
Do brain mets develop differently for these categories?
What features predict BM?
Primary site, common, t_stage, n_stage, hist_type, etc

- INCIDENCE 
    - priamry_site
    - incidence rate ratios rather than odds ratios 
    - Survival curves (but brain met)

Sites 
- assumed_primary (for a given brain met)
- Breast: 2 categories.
    - low stage, low grade: low probability of metastasis in general 
    - molecular subtypes for breast cancer determine aggressiveness (TNBC=most lethal/aggressive, HER2 etc)
- check placenta C589 "other female..."

Contrasts 
- do everything with site_category
- lung vs rest 
    - lung is super different from everything? 
- historical 'common' vs rest           [lung, breast, renal, skin, colorectal]
- data-driven 'common' vs rest          [lung, esophagus, renal, testis] (above 1% prev)
- data-driven 'uncommon' vs rest        [prostate, leukemia]
- data-driven 'common' vs data-driven 'uncommon'

- single vs multisite
    - do odds ratios etc for sinlges 
    - add last tumor for multis 
    - do they differ? 

AJCC stage group 
- don't mix c & p 
- c = clinical 
- p = pathological


---------------
--- RESULTS ---
---------------

--- BREAST ---

GSTAGE_STD vs BRAIN_MET (763723 records) ---
GSTAGE_STD       0       I      II    III     IV
BRAIN_MET                                       
NO          136213  324134  162665  55311  33873
YES              0       0       0      0   2738

Mutual Information (normalized): 0.017



---------------------------------
--- SEER PROSTATE / COMBIMETS ---
---------------------------------

PSA 
- only produced in prostate
- if detected in blood == you have a prostate. 
- if prostate removed && you still have PSA, you have met / circulating tumor cells 
    - PSA reading == 0.01-0.2: 10% will have a met
    - PSA reading == 0.2-0.1:  50% will have a met


-------------------
--- BASIC STATS ---
-------------------
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8198228/#:~:text=However%2C%20in%20studies%20comparing%20the,risk%20for%20risk%20ratios%20less
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4640017/#:~:text=The%20relative%20risk%20(also%20known,event%20in%20the%20other%20group.
https://sphweb.bumc.bu.edu/otlt/mph-modules/ep/ep713_association/ep713_association3.html#:~:text=Rate%20ratios%20are%20closely%20related,or%20less%20exposed)%20comparison%20group.

RESEARCH QUESTIONS
- Prostate doesn't go to brain cuz slow growing?
- Is there a data-driven definition of common|uncommon BM primaries? adjust for:
    - cancer growth rate 
    - how 'early' a cancer is detected (community screening/checkups)?
- What features (t_stage; n_stage; t_stage+n_stage; hist_type) predict BM? 

IMPORTANT
- conditional probabilities / or normalization absolutely required. 
    - OK?:  Odds ratio LUNG G1 vs G2 cuz single variable tested.
    - OK?:  Mutual Information ALL_SITES G1 vs G2 cuz single variable tested.
    - BAD:  Odds ratio LUNG_G1 vs PROSTATE_G1 cuz 2 variables (primary; stage)
- multivariate statistics probably best 
    - JUST OK: T_STAGE alone to predict BM. 
    - BETTER: A combination of T_STAGE and N_STAGE.

Main items
- prevalence (period prev 2010-2020)
- incidence (non-bm patients who later developed a bm)
- Do grade again, but comparison is odds ratio (common&T1 vs uncommon &T1) etc
- mutual information (MI)
- conditional mutual information (CMI)
- multivariate information (MVI) theory 
- decision tree 


Prevalence: 
- the proportion of all people in the study population who have the outcome of interest (e.g., disease or condition) at a particular time
- # people affected / # people in study 
- X cases per Y people
- eg 
    # people in study = 10,000
    # diabetes = 1,000
    prevalence = 1,000 / 10,000 
        or 100 cases per 1,000 people
        or 10 cases per 100 people 
        or 1 in 10
- point prevalence: prevalence at single point in time (eg "as of 2020")
- period prevalence: prevalence within a time range (eg 2010-2015)

Incidence:
- different to prevalence
- the proportion of at-risk subjects who develop the outcome of interest
- incidence proportion: probability of developing BM before 2020 among all subjects at risk
- incidence rate:       frequency per time per person (eg 11.1 new cases of BM per year per 1000 ppl)  
- eg 
    10,000 subjects
    1,000 already have diabetes 
    9,000 at risk
    5 year observation period, 500 new cases by end 

    incidence proportion (cumulative incidence):
    500/9000 or 55.5 cases per 1000 or 5.6%
    
    incidence rate:
    total person years = 9000 * 5 = 45,000
    500/45,000 = 11.1 cases per 1000 ppl per year 

incidence rate ratio (IRRs)
- need at least 2 time points
- https://ehp.niehs.nih.gov/doi/full/10.1289/EHP7246
- https://www.ncbi.nlm.nih.gov/books/NBK555593/figure/ch5.fig2/
- incidence rate per primary = x per 10000 cases 
- split into 
    - primary type
    - common/uncommon
    - T/N stage 
    - Group stage 
    - Grade
- ratios can then be calculated 
    - common vs common 
    - breast vs prostate
    - Grade.G2 vs Grade.G1 etc 
- p-value? CI? does this need group mean test?
- eg 
    HRT     # with disease  
    YES     30
    NO      60


Risk
- "the probability that an outcome will occur"
- need at least 2 time points
- risk ratio = relative risk = RR
- joint/marginal probabilities
- risk of BM = has_bm/no_bm (entire dataset)
                YES_BM  NO_BM   Grade Margin
    Grade.G2         a      b            a+b
    Grade.G1         c      d            c+d
    BM Margin      a+c    b+d

- risk Grade.G2 G2 = a/a+b
- risk Grade.G1 G1 = c/c+d
- risk ratio  (G2) = G2 / G1
- excess risk (G2) = G2 - G1   (attributable risk)
- p-value? 

odds ratio 
- a single point in time 
- https://www.researchgate.net/figure/Odds-ratio-OR-and-95-confidence-interval-CI-per-increment-of-1-standard-deviation-of_fig2_292071941
- same as RR but odds 
- odds "the probability that an event occurs divided by the probability that the event does not occur"

Hazard ratio
- https://www.ncbi.nlm.nih.gov/pmc/articles/PMC478551/
- cox proportional hazards model
- survival analysis
- Students t-test (para) or Wilcoxon rank-sum test (non-para)?
- comparing two groups
- similar to IRRs 
"Hazard ratios differ from relative risks (RRs) and odds ratios (ORs) in that RRs and ORs are cumulative over an entire study, using a defined endpoint, while HRs represent instantaneous risk over the study time period, or some subset thereof. Hazard ratios suffer somewhat less from selection bias with respect to the endpoints chosen and can indicate risks that happen before the endpoint."

Mutual information 
- measures patterns of change for categorical variables
- if we want continuous variables
    - create histogram  
    - use each bin as discrete cateogry 
- both negative correlation and positive result in same MI value (ie can be inverse relationship)
- calc perfect situation (var1 & var2 exact same for each obs) for relative scaling? 

---------------------
--- MODEL FITTING ---
---------------------

Model Fitting Strategy
- For each method, do feature selection rather than feature extraction
- Akaike information criterion (AIC) or something to penalise model complexity? 
- plot num_features vs accuracy (or some other metric) to decide 
- FDR for multiple testing needs to be calculated

Decision Tree 
- 
Generalized Additive Model
- https://ehp.niehs.nih.gov/doi/full/10.1289/EHP7246

LOESS Model
- https://ehp.niehs.nih.gov/doi/full/10.1289/EHP7246

Other Possible Approaches
- GLM 
    - predictor dist: binomial|bernoulli
    - link function:  log-odds
- 
